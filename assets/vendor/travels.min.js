/*!
 * Travels history runtime for LaTeX Lab.
 * Exposes window.createTravels and window.Travels.createTravels.
 */
(function (globalScope) {
  'use strict';

  function cloneState(value) {
    if (value === null || value === undefined) return value;
    if (typeof value !== 'object') return value;
    if (Array.isArray(value)) {
      var nextArray = new Array(value.length);
      for (var i = 0; i < value.length; i += 1) {
        nextArray[i] = cloneState(value[i]);
      }
      return nextArray;
    }
    var nextObject = {};
    for (var key in value) {
      if (Object.prototype.hasOwnProperty.call(value, key)) {
        nextObject[key] = cloneState(value[key]);
      }
    }
    return nextObject;
  }

  function statesEqual(a, b) {
    if (a === b) return true;
    if (a === null || b === null || a === undefined || b === undefined) return false;
    if (typeof a !== typeof b) return false;
    if (typeof a !== 'object') return a === b;
    if (Array.isArray(a) !== Array.isArray(b)) return false;
    if (Array.isArray(a)) {
      if (a.length !== b.length) return false;
      for (var i = 0; i < a.length; i += 1) {
        if (!statesEqual(a[i], b[i])) return false;
      }
      return true;
    }
    var aKeys = Object.keys(a);
    var bKeys = Object.keys(b);
    if (aKeys.length !== bKeys.length) return false;
    for (var j = 0; j < aKeys.length; j += 1) {
      var key = aKeys[j];
      if (!Object.prototype.hasOwnProperty.call(b, key)) return false;
      if (!statesEqual(a[key], b[key])) return false;
    }
    return true;
  }

  function normalizeMaxHistory(value) {
    var n = Number(value);
    if (!Number.isFinite(n)) return 100;
    n = Math.floor(n);
    return n < 1 ? 1 : n;
  }

  function createTravels(initialState, options) {
    var maxHistory = normalizeMaxHistory(options && options.maxHistory);
    var entries = [cloneState(initialState)];
    var index = 0;

    function getState() {
      return cloneState(entries[index]);
    }

    function setState(nextState) {
      var next = cloneState(nextState);
      if (statesEqual(entries[index], next)) return getState();
      if (index < entries.length - 1) {
        entries = entries.slice(0, index + 1);
      }
      entries.push(next);
      if (entries.length > maxHistory) {
        entries.splice(0, entries.length - maxHistory);
      }
      index = entries.length - 1;
      return getState();
    }

    function canBack() {
      return index > 0;
    }

    function canForward() {
      return index < entries.length - 1;
    }

    function back() {
      if (canBack()) index -= 1;
      return getState();
    }

    function forward() {
      if (canForward()) index += 1;
      return getState();
    }

    return {
      setState: setState,
      getState: getState,
      canBack: canBack,
      canForward: canForward,
      back: back,
      forward: forward
    };
  }

  var exports = (globalScope.Travels && typeof globalScope.Travels === 'object')
    ? globalScope.Travels
    : {};
  exports.createTravels = createTravels;
  globalScope.Travels = exports;
  globalScope.createTravels = createTravels;
})(typeof window !== 'undefined' ? window : globalThis);
