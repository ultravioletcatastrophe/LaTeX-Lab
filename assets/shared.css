/* =====================
   Fonts (single source)
   ===================== */
/* We define CMU Serif here and DO NOT include the external CM stylesheet to avoid duplication. */
@font-face{
  font-family:"CMU Serif";
  src:url("https://cdn.jsdelivr.net/npm/computer-modern@0.1.3/fonts/cmu-serif-500-roman.woff2") format("woff2");
  font-weight:500; font-style:normal; font-display:swap;
}
@font-face{
  font-family:"CMU Serif";
  src:url("https://cdn.jsdelivr.net/npm/computer-modern@0.1.3/fonts/cmu-serif-500-italic.woff2") format("woff2");
  font-weight:500; font-style:italic; font-display:swap;
}
@font-face{
  font-family:"CMU Serif";
  src:url("https://cdn.jsdelivr.net/npm/computer-modern@0.1.3/fonts/cmu-serif-700-roman.woff2") format("woff2");
  font-weight:700; font-style:normal; font-display:swap;
}
@font-face{
  font-family:"CMU Serif";
  src:url("https://cdn.jsdelivr.net/npm/computer-modern@0.1.3/fonts/cmu-serif-700-italic.woff2") format("woff2");
  font-weight:700; font-style:italic; font-display:swap;
}

/* =====================
   Theme tokens
   ===================== */
:root{
  --bg:#ffffff; --text:#111; --gutter-bg:#f4f4f4; --gutter-text:#888;
  --stripe-light: rgba(0,0,0,.03);
  --border: rgba(0,0,0,.12);
}
body.dark{
  --bg:#121212; --text:#eee; --gutter-bg:#1f1f1f; --gutter-text:#aaa;
  --stripe-light: rgba(255,255,255,.04);
  --border: rgba(255,255,255,.14);
}

/* =====================
   Base layout
   ===================== */
*{box-sizing:border-box}
html,body{height:100%;margin:0;overflow:hidden}
body{
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  background:var(--bg); color:var(--text);
  display:flex; flex-direction:column; transition:background .18s,color .18s;
}

/* =====================
   Toolbar
   ===================== */
.toolbar{ border-bottom:1px solid var(--border); display:flex; align-items:center; gap:.5rem; padding:.5rem 1rem; flex-wrap:wrap; }
.toolbar .fill{ flex:1 1 auto; }
.collab-controls{ display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
.collab-controls input{ width:160px; padding:.35rem .55rem; border-radius:6px; border:1px solid var(--border); font-size:14px; }
#displayNameInput{ width:140px; }
.collab-controls button{ padding:.38rem .7rem; border-radius:6px; border:1px solid var(--border); background:rgba(255,255,255,.95); font-size:14px; cursor:pointer; }
body.dark .collab-controls button{ background:linear-gradient(#222,#1b1b1b); }
.collab-status{ font-size:12px; opacity:.75; min-width:140px; }
.menu{ position:relative; display:inline-block }
.menu-button, button{
  padding:.45em .7em; border-radius:6px; border:1px solid var(--border);
  background:rgba(255,255,255,.95); cursor:pointer; font-size:14px; color:inherit;
}
body.dark .menu-button, body.dark button{ background:linear-gradient(#222,#1b1b1b) }
.menu-button:active, button:active{ transform:translateY(1px) }
.menu ul{
  position:absolute; z-index:10; min-width:220px; margin:.3rem 0 0; padding:.4rem 0;
  background:var(--bg); color:var(--text); list-style:none; border:1px solid var(--border); border-radius:8px;
  box-shadow:0 6px 24px rgba(0,0,0,.12); display:none;
}
.menu.open ul{ display:block }
.menu ul li{ padding:.45rem .75rem; cursor:pointer }
.menu ul li:hover{ background:var(--stripe-light) }

/* =====================
   Split panes
   ===================== */
.container{ flex:1; display:flex; min-height:0; overflow:hidden }
#leftPane{ flex:0 0 50%; display:flex; min-width:260px; border-right:1px solid var(--border); min-height:0 }
#gutter{
  width:4.8em; padding-top:.6em; padding-bottom:calc(.6em + var(--mobile-editor-end-pad, 0px)); background:var(--gutter-bg); color:var(--gutter-text);
  font-family:monospace; font-size:15px; text-align:right; user-select:none; overflow:auto; pointer-events:none;
  scrollbar-width: none;
}
#gutter::-webkit-scrollbar{ display:none; }
#gutter .ln{display:block; padding-right:.6em}
/* Single rule handles both themes */
#gutter .ln:nth-child(odd){ background-color:var(--stripe-light) }

#editorWrap{ position:relative; flex:1; overflow:hidden; background: var(--bg); min-height:0 }
#overlay{
  position:absolute; inset:0; pointer-events:none; z-index:2;
  overflow:auto;                 /* let the overlay content scroll */
  scrollbar-width: none;         /* hide in Firefox */
}
#overlay::-webkit-scrollbar{ display:none; }  /* hide in Chromium/WebKit */
#overlay .overlay-line{ width:100%; }
#overlay .wrap-row{ width:100%; }
#editor{
  position:relative; width:100%; height:100%; padding:.6em 1em calc(.6em + var(--mobile-editor-end-pad, 0px)) 1em; font-family:monospace; font-size:15px; line-height:1.5;
  border:none; outline:none; background:transparent; color:var(--text); resize:none; overflow:auto;
  overscroll-behavior: none;
  -webkit-overflow-scrolling: touch;
}

#overlay, #gutter, #preview{
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
}

/* Divider */
#divider{
  width:12px; cursor:col-resize;
  background:
    radial-gradient(currentColor 22%, transparent 23%) center 14px/6px 10px no-repeat,
    radial-gradient(currentColor 22%, transparent 23%) center 28px/6px 10px no-repeat,
    linear-gradient(90deg, transparent, var(--border), transparent);
  color:#aaa;
}
#divider:hover{ color:#777 }
body.dark #divider{ color:#bbb }

/* Preview */
#preview{ flex:1; padding:1.25rem; overflow:auto; background:var(--bg); color:var(--text); font-size:16px; line-height:1.6; white-space:pre-wrap; min-height:0 }

/* Explicit mobile mode: preview on top, editor on bottom */
@media (max-width: 900px){
  html, body{ height:100dvh; }
  .container{ flex-direction:column-reverse; }
  #leftPane, #preview{ flex:1 1 50%; min-height:0; }
  #leftPane{ min-width:0; border-right:none; border-top:1px solid var(--border); }
  #divider{ display:none; }
  #preview{ padding:1rem; }
  #editor{ font-size:16px; }
  #gutter{ width:3.8em; }
}

/* Mobile cursor pad (appears above keyboard while editing) */
.mobile-cursor-pad{
  position:fixed;
  right:calc(env(safe-area-inset-right) + 10px);
  left:auto;
  transform:none;
  bottom:calc(var(--mobile-keyboard-inset, 0px) + env(safe-area-inset-bottom) + 10px);
  z-index:9000;
  display:none;
  grid-template-columns:42px 42px 42px;
  grid-template-rows:42px 42px 42px;
  gap:6px;
  padding:0;
  border:none;
  border-radius:0;
  background:transparent;
  box-shadow:none;
  backdrop-filter:none;
}
@media (max-width: 900px){
  .mobile-cursor-pad.show{ display:grid; }
  #clearBtn{ display:none; }

  body.collab .toolbar{
    row-gap:.45rem;
    align-items:center;
  }
  body.collab .toolbar .fill{
    display:none;
  }
  body.collab .toolbar .collab-controls{
    display:contents;
  }
  body.collab .toolbar #displayNameInput{
    order:3;
    flex:1 1 140px;
    width:auto;
    min-width:110px;
    max-width:none;
  }
  body.collab .toolbar #roomNameInput{
    order:10;
    flex:1 1 calc(100% - 112px);
    width:auto;
    min-width:0;
  }
  body.collab .toolbar #roomJoinBtn{
    order:11;
    flex:0 0 auto;
  }
  body.collab .toolbar #collabStatus{
    display:none;
  }
  body.collab .toolbar #shareRoomBtn{
    display:none !important;
  }
}
.mobile-cursor-pad-btn{
  border:1px solid var(--border);
  border-radius:10px;
  background:transparent;
  color:var(--text);
  font-size:20px;
  line-height:1;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  padding:0;
  touch-action:none;
}
.mobile-cursor-pad-btn:active{
  transform:translateY(1px);
}
.mobile-cursor-pad-btn.dir-up{ grid-column:2; grid-row:1; }
.mobile-cursor-pad-btn.dir-left{ grid-column:1; grid-row:2; }
.mobile-cursor-pad-btn.dir-right{ grid-column:3; grid-row:2; }
.mobile-cursor-pad-btn.dir-down{ grid-column:2; grid-row:3; }
.mobile-cursor-pad-center{
  grid-column:2;
  grid-row:2;
  border-radius:10px;
  border:1px dashed transparent;
  background:transparent;
}

@media (max-width: 900px){
  .toolbar,
  .controls{
    transition:transform .2s ease, opacity .2s ease;
  }
  body.mobile-keyboard-open .toolbar{
    position:fixed;
    top:0;
    left:0;
    right:0;
    transform:translateY(calc(-100% - 8px));
    opacity:0;
    pointer-events:none;
    z-index:1200;
  }
  body.mobile-keyboard-open .controls{
    position:fixed;
    left:0;
    right:0;
    bottom:0;
    transform:translateY(calc(100% + 8px));
    opacity:0;
    pointer-events:none;
    z-index:1200;
  }
  body.mobile-keyboard-open #preview{
    flex:0 0 var(--mobile-preview-lock-height, 46dvh);
    min-height:140px;
  }
  body.mobile-keyboard-open #leftPane{
    flex:1 1 auto;
    min-height:0;
  }
}

/* Consistent tab rendering */
#editor, #preview { tab-size: 4; -moz-tab-size: 4; }

/* Controls */
.controls{ min-height:88px; border-top:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; padding:.5rem 1rem 1rem; gap:1rem; background:linear-gradient(to top, rgba(0,0,0,.01), transparent); }
.left-controls,.right-controls{ display:flex; align-items:center; gap:1rem }
.center-controls{ flex:1; display:flex; justify-content:center; min-width:0; }

@media (max-width: 900px){
  .controls{
    min-height:auto;
    align-items:flex-start;
    padding:.5rem 1rem .75rem;
  }
  .left-controls{
    align-items:flex-start;
  }
  .right-controls{
    margin-left:auto;
    flex-direction:column;
    align-items:flex-end;
    align-self:flex-start;
    justify-content:flex-start;
    gap:.45rem;
  }
  .right-controls .dark-switch{
    order:1;
  }
  .right-controls #pngBtn{
    order:2;
  }
}

/* Presence list (collab) */
.presence-list{ display:flex; align-items:center; justify-content:center; gap:.65rem; flex-wrap:wrap; font-size:13px; color:var(--text); max-width:100%; }
.presence-item{ display:flex; align-items:center; gap:.4rem; padding:.35rem .65rem; border:1px solid var(--border); border-radius:999px; background:rgba(255,255,255,.9); box-shadow:0 1px 2px rgba(0,0,0,.08); max-width:200px; transition:background .18s,border-color .18s,box-shadow .18s; }
.presence-item.self{ font-weight:600; cursor:pointer; box-shadow:0 4px 18px rgba(30,167,253,.18); position:relative; }
.presence-item.self:hover, .presence-item.self:focus-visible{ box-shadow:0 6px 22px rgba(30,167,253,.24); }
body.dark .presence-item{ background:rgba(34,34,34,.85); box-shadow:0 1px 2px rgba(0,0,0,.28); }
body.dark .presence-item.self{ background:rgba(48,48,48,.9); box-shadow:0 0 0 1px rgba(30,167,253,.45), 0 10px 26px rgba(0,0,0,.6); }
body.dark .presence-item.self:hover, body.dark .presence-item.self:focus-visible{ box-shadow:0 0 0 1px rgba(30,167,253,.6), 0 12px 30px rgba(0,0,0,.68); }
.presence-color{ width:10px; height:10px; border-radius:50%; box-shadow:0 0 0 2px rgba(0,0,0,.08); flex-shrink:0; }
.presence-main{ display:flex; flex-direction:column; gap:2px; min-width:0; }
.presence-name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:142px; }
.presence-tone{ font-size:11px; text-transform:uppercase; letter-spacing:.05em; opacity:.6; white-space:nowrap; }

@media (max-width: 900px){
  .presence-list{
    gap:.35rem;
    font-size:12px;
  }
  .presence-item{
    gap:.28rem;
    padding:.22rem .46rem;
    max-width:145px;
    box-shadow:0 1px 1px rgba(0,0,0,.08);
  }
  .presence-item.self{
    box-shadow:0 2px 10px rgba(30,167,253,.16);
  }
  .presence-item.self:hover, .presence-item.self:focus-visible{
    box-shadow:0 3px 12px rgba(30,167,253,.2);
  }
  .presence-color{
    width:8px;
    height:8px;
    box-shadow:0 0 0 1px rgba(0,0,0,.08);
  }
  .presence-main{
    gap:1px;
  }
  .presence-name{
    max-width:96px;
  }
  .presence-tone{
    display:none;
  }
}

/* Mode slider (wide) */
.switch.mode{ position:relative; width:120px; height:36px; display:inline-block }
.switch.mode input{ display:none }
.switch.mode .track{ position:absolute; inset:0; border-radius:999px; border:1px solid var(--border); background:transparent; display:flex; align-items:center; justify-content:space-between; padding:0 9px; }
.switch.mode .thumb{ position:absolute; top:50%; left:4px; width:60px; height:30px; background:#fff; border-radius:999px; box-shadow:0 2px 6px rgba(0,0,0,.22); transform:translate(0,-50%); transition:transform .18s; }
body.dark .switch.mode .thumb{ background:#2a2a2a }
.stack{ display:flex; flex-direction:column; align-items:center; line-height:1.0; font-size:10px; font-weight:700; opacity:.45; transition:opacity .18s; user-select:none; }
.switch.mode .stack { transform: translateY(-0.5px); }
#modeToggle:checked + .track .stack.all{ opacity:1 }
#modeToggle:not(:checked) + .track .stack.some{ opacity:1 }
#modeToggle:not(:checked) + .track .thumb{ transform:translate(50px,-50%) }

/* Dark slider (compact) */
.switch.dark{ position:relative; width:64px; height:34px; display:inline-block }
.switch.dark input{ display:none }
.switch.dark .track{ position:absolute; inset:0; border-radius:999px; border:1px solid var(--border); background:transparent; display:flex; align-items:center; justify-content:space-between; padding:0 6px; }
.switch.dark .thumb{ position:absolute; top:50%; left:3px; width:28px; height:28px; background:#fff; border-radius:50%; box-shadow:0 2px 6px rgba(0,0,0,.22); transform:translate(0,-50%); transition:transform .18s; }
body.dark .switch.dark .thumb{ background:#2a2a2a }
.emoji{ font-size:16px; filter: drop-shadow(0 0 2px rgba(0,0,0,.35)); opacity:.45; transition:opacity .18s; user-select:none }
#darkToggle:not(:checked) + .track .sun{ opacity:1 }
#darkToggle:checked + .track .moon{ opacity:1 }
#darkToggle:checked + .track .thumb{ transform:translate(28px,-50%) }

/* Labels */
#modeLabel{ display:none }
#modeDesc{ font-size:12px; opacity:.8 }
@media (max-width: 900px){
  #modeDesc{ white-space:pre-line; }
}

/* Modals */
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999; }
.modal-backdrop.show{ display:flex }
.modal{ width:min(540px,92vw); background:var(--bg); color:var(--text); border-radius:12px; padding:1rem; border:1px solid var(--border) }
.modal h3{ margin:.2rem 0 1rem 0 }
.modal .row{ display:flex; gap:.75rem; align-items:center; margin:.5rem 0; flex-wrap:wrap }
.modal label{ min-width:4.5rem }
.modal input[type="number"], .modal select { width:100px; padding:.35rem .4rem }
.modal .preview{ margin-top:.75rem; padding:.75rem; border-radius:8px; border:1px dashed var(--border); font-family:monospace; white-space:pre-wrap; max-height:240px; overflow:auto; }
.modal .actions{ display:flex; justify-content:flex-end; gap:.5rem; margin-top:1rem }

/* Mixed mode: use CMU Serif for plain text, let KaTeX keep its own fonts */
body.mixed #preview { font-family: "CMU Serif"; font-weight: 500; font-size:20px; line-height:1.4; }

/* Make entire pill clickable */
.switch .track { cursor: pointer; }

/* Hidden measuring div to compute line wrap heights */
#measure{ position:absolute; visibility:hidden; top:-9999px; left:-9999px; box-sizing:content-box; padding:0; margin:0; border:0; white-space:pre-wrap; word-break:break-word; overflow-wrap:break-word; }

.mobile-self-caret{
  position:absolute;
  top:0;
  left:0;
  display:none;
  pointer-events:none;
  z-index:4;
}
.mobile-self-caret-bar{
  position:absolute;
  top:0;
  left:0;
  width:2px;
  border-radius:1px;
  animation: caretBlink 1.1s steps(1) infinite;
}

/* =====================
   Collaboration overlays
   ===================== */
#remoteLayer{ position:absolute; inset:0; pointer-events:none; z-index:3; overflow:visible; }
.remote-caret{ position:absolute; top:0; left:0; display:block; pointer-events:none; font-size:12px; font-weight:600; }
@keyframes caretBlink { 0%,49%{ opacity:1; } 50%,99%{ opacity:0; } }
.remote-caret-bar{ width:2px; border-radius:1px; flex-shrink:0; animation: caretBlink 1.1s steps(1) infinite; position:absolute; top:0; left:0; }
.remote-caret-label{
  position:absolute;
  padding:2px 6px;
  border-radius:999px;
  color:#fff;
  font-size:11px;
  line-height:1.2;
  box-shadow:0 2px 6px rgba(0,0,0,.25);
  white-space:nowrap;
  opacity:0;
  transition:opacity .14s;
  pointer-events:none;
  transform:translate(-50%,-120%);
  left:50%;
}
.remote-caret.show-label .remote-caret-label{ opacity:1; }
.remote-caret.label-below .remote-caret-label{ transform:translate(-50%,140%); }

/* Collab-specific layering */
body.collab #leftPane { position: relative; }
body.collab #gutter { position: relative; z-index: 1; }
body.collab #editorWrap { position: relative; z-index: 2; overflow: hidden; }
body.collab #remoteLayer { overflow: hidden; pointer-events: none; }

/* =====================
   Welcome pop styles
   ===================== */
.welcome-pop{ position: fixed; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 10px; box-shadow: 0 6px 20px rgba(0,0,0,.25); padding: 1rem; z-index: 99999; display: none; }
.welcome-pop h3 { margin: 0 0 .5rem; }
.welcome-pop p  { font-size: 13px; line-height: 1.45; margin: 0 0 .75rem; }
.welcome-pop ul{ margin:0 0 .9rem; padding-left:1.1rem; font-size:13px; line-height:1.5; }
.welcome-pop li{ margin-bottom:.45rem; }
.welcome-pop button { padding: .35em .7em; border-radius: 6px; border: 1px solid var(--border); background: rgba(255,255,255,.95); cursor: pointer; font-size: 13px; }
body.dark .welcome-pop { background: #1e1e1e; }

body[data-welcome="corner"] .welcome-pop{ bottom: 1rem; right: 1rem; max-width: 360px; animation: fadeInUp .35s ease; }
body[data-welcome="modal"] .welcome-pop{ top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: min(480px, calc(100% - 2rem)); border-radius: 12px; box-shadow: 0 18px 38px rgba(0,0,0,.24); padding: 1.1rem 1.3rem; animation: fadeInScale .25s ease; }
body[data-welcome="modal"] #joinPop{ max-width: min(420px, calc(100% - 2rem)); }

.welcome-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:99998; display:none; }

@keyframes fadeInUp { from { opacity:0; transform:translateY(12px) } to { opacity:1; transform:translateY(0) } }
@keyframes fadeInScale { from { opacity:0; transform: translate(-50%, -48%) scale(.97); } to { opacity:1; transform: translate(-50%, -50%) scale(1); } }
@media (max-width: 520px) {
  body[data-welcome="corner"] .welcome-pop { left: 1rem; right: 1rem; max-width: none; }
  body[data-welcome="modal"] .welcome-pop { width: calc(100% - 2rem); }
}

/* Join pop options */
.join-pop-option{ display:flex; align-items:center; gap:.4rem; font-size:12px; margin:0 0 .75rem; }
.join-pop-option input{ margin:0; }
.join-pop-actions{ display:flex; gap:.5rem; justify-content:flex-end; }
.join-pop-actions button{ flex:1 1 auto; }

/* iOS Safari: avoid focus zoom on small text inputs */
@media (max-width: 900px){
  .collab-controls input{ font-size:16px; }
}
